<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCES</title>
    <style>

        .message-container {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            max-width: 80%;
        }

        .message-content {
        padding: 10px;
        border-radius: 5px;
        background-color: white;
        display: block;        /* ‚Üê stack children one after another */
        word-wrap: break-word;
        }

        .edit-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            color: #007bff;
        }

        .edit-btn:hover {
            text-decoration: underline;
        }

        .citations {
            font-size: 12px;
            color: gray;
            margin-top: 5px;
        }

        .citations-section {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 3px solid #007bff;
            border-radius: 4px;
        }

        .citations-section strong {
            color: #007bff;
            font-weight: bold;
        }

        .save-btn, .cancel-btn {
            margin-top: 5px;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }

        .save-btn {
            background-color: #28a745;
            color: white;
        }

        .cancel-btn {
            background-color: #dc3545;
            color: white;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            height: 100vh;               /* Fixed height for single page */
            display: flex;
            background-color: #f0f0f0;
            overflow: hidden;            /* Prevent body scrolling */
        }
        .container {
            display: flex;
            width: 100%;
            height: 100vh;               /* Fixed height for single page */
            overflow: hidden;            /* Prevent container scrolling */
        }

        .sidebar .light-btn {
            background-color: #a3c2f2;  /* Light blue */
            color: black;
            font-weight: bold;
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .sidebar .dark-btn {
            background-color: #1f4e79;  /* Dark blue */
            color: white;
            font-weight: bold;
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .sidebar .light-btn:hover {
            background-color: #8ab1eb;
        }

        .sidebar .dark-btn:hover {
            background-color: #163d5d;
        }

        .discipline-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .discipline-checkbox {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 12px;
        }

        .discipline-checkbox input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.1);
        }

        .discipline-checkbox label {
            cursor: pointer;
            color: #ddd;
            flex: 1;
        }

        .discipline-description {
            font-size: 10px;
            color: #999;
            margin-left: 20px;
            font-style: italic;
        }

        .discipline-validation {
            font-size: 11px;
            margin-top: 5px;
            padding: 5px;
            border-radius: 3px;
        }

        .discipline-validation.success {
            background-color: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .discipline-validation.error {
            background-color: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }

        /* Markdown styling for AI responses */
        .ai-message .message-content h1 {
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0 8px 0;
            color: #333;
        }

        .ai-message .message-content h2 {
            font-size: 16px;
            font-weight: bold;
            margin: 8px 0 6px 0;
            color: #444;
        }

        .ai-message .message-content h3 {
            font-size: 14px;
            font-weight: bold;
            margin: 6px 0 4px 0;
            color: #555;
        }

        .ai-message .message-content strong {
            font-weight: bold;
            color: #2c3e50;
        }

        .ai-message .message-content br {
            line-height: 1.6;
        }

        /* Citation styling */
        .ai-message .message-content strong {
            font-weight: 600;
        }

        /* Special styling for citations section */
        .citations-section {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .citations-section strong {
            color: #2c3e50;
            font-weight: 600;
        }

        .sidebar {
            background-color: #333;
            color: white;
            width: 220px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 12px;               /* Slightly reduced padding */
            overflow-y: auto;
            transition: all 0.3s ease;
            flex-shrink: 0;
            scroll-behavior: smooth;     /* Smooth scrolling */
        }

        /* Custom scrollbar for sidebar */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .sidebar.collapsed {
            width: 60px;
            padding: 10px 0;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;                   /* Remove default margins */
        }

        .sidebar ul li {
            margin: 5px 0;               /* Reduced from 8px to save space */
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;             /* Slightly smaller font */
        }

        .sidebar ul li.no-bullet {
            margin: 8px 0;               /* Keep space between red boxes */
        }

        .sidebar .toggle-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 6px;                /* Further reduced padding */
            cursor: pointer;
            text-align: left;
            margin-bottom: 10px;         /* Further reduced margin */
            width: 100%;
            border-radius: 4px;
            font-size: 14px;             /* Smaller font size */
        }

        .sidebar.collapsed .toggle-btn {
            text-align: center;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;               /* Full viewport height */
            flex: 1;                     /* Take remaining space */
            overflow: hidden;            /* Prevent overflow */
        }
        .chat-header {
            background-color: #007bff;
            color: white;
            padding: 15px;               /* Reduced padding */
            text-align: center;
            flex-shrink: 0;              /* Don't shrink */
        }
        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        .logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }
        .chat-messages {
            flex: 1;                     /* Take available space */
            overflow-y: auto;
            padding: 15px;               /* Reduced padding */
            background-color: #ffffff;
            min-height: 0;               /* Allow flex shrinking */
        }
        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            max-width: 80%;
            display: flex;
            flex-direction: column;
        }
        .user-message {
            background-color: #007bff;
            color: rgb(0, 0, 0);
            align-self: flex-end;
        }
        .ai-message {
            background-color: #f1f1f1;
            align-self: flex-start;
        }
        .message-text {
            word-wrap: break-word;
        }
        .citations {
            font-size: smaller;
            color: gray;
            margin-top: 5px;
        }
        .chat-input {
            display: flex;
            padding: 8px;                /* Reduced padding */
            background-color: #ffffff;
            border-top: 1px solid #ddd;
            flex-shrink: 0;              /* Don't shrink */
        }
        #user-input {
            flex-grow: 1;
            padding: 8px;                /* Reduced padding */
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        button:disabled {
            background-color: #cccccc;
        }
        .logo {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 50px;
            height: 50px;
        }
        .toast {
            position: fixed;
            bottom: 50%;
            left: 50%;
            transform: translate(-50%, 50%);
            background-color: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 9999;
        }
        .toast.show {
            opacity: 1;
        }
        .group-box {
            border: 1px solid #131313;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #000000;
        }

        /* Modal Styles for Patient Notes */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .patient-notes-modal {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* Conversation Segments Modal Styles */
        .conversation-segments-modal {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .segments-section {
            margin-bottom: 20px;
        }

        .segments-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .segments-container {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #f9f9f9;
        }

        .segment-item {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .segment-item.doctor {
            border-left-color: #28a745;
            background-color: #f8fff9;
        }

        .segment-item.patient {
            border-left-color: #17a2b8;
            background-color: #f8fcff;
        }

        .segment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .segment-role {
            font-weight: bold;
            font-size: 14px;
        }

        .segment-role.doctor {
            color: #28a745;
        }

        .segment-role.patient {
            color: #17a2b8;
        }

        .segment-timing {
            font-size: 12px;
            color: #666;
            background-color: #f0f0f0;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .segment-confidence {
            font-size: 11px;
            color: #888;
            margin-left: 10px;
        }

        .segment-text {
            color: #333;
            line-height: 1.4;
            font-size: 14px;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #007bff;
        }

        .modal-header h2 {
            color: #007bff;
            margin: 0;
            font-size: 24px;
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-section label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .modal-section input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .modal-section textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 150px;
            font-family: Arial, sans-serif;
            line-height: 1.5;
        }

        .modal-section textarea[readonly] {
            background-color: #f8f9fa;
            border-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }

        .modal-section input[readonly] {
            background-color: #f8f9fa;
            border-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }

        .modal-section input:focus,
        .modal-section textarea:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
        }

        .modal-btn.save {
            background-color: #28a745;
            color: white;
        }

        .modal-btn.save:hover {
            background-color: #218838;
        }

        .modal-btn.save-duplicate {
            background-color: #17a2b8;
            color: white;
        }

        .modal-btn.save-duplicate:hover {
            background-color: #138496;
        }

        .modal-btn.cancel {
            background-color: #dc3545;
            color: white;
        }

        .modal-btn.cancel:hover {
            background-color: #c82333;
        }

        .modal-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .modal-info h3 {
            margin: 0 0 10px 0;
            color: #007bff;
        }

        .modal-info p {
            margin: 5px 0;
            color: #666;
        }

        /* Enhanced Modal Styles */
        .main-header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .main-header h1 {
            margin: 0 0 10px 0;
            font-size: 22px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .main-header h2 {
            margin: 0;
            font-size: 16px;
            font-weight: normal;
            opacity: 0.9;
        }

        .names-section {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 2px solid #007bff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
        }

        .name-display {
            flex: 1;
            text-align: center;
            font-size: 14px;
            color: #333;
            background-color: white;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .session-info-box {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
        }

        .session-info-box h3 {
            margin: 0 0 15px 0;
            color: #1976d2;
            font-size: 16px;
            font-weight: bold;
        }

        .session-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .session-item {
            background-color: white;
            padding: 8px 12px;
            border-radius: 4px;
            border-left: 4px solid #2196f3;
            font-size: 13px;
        }

        .transcription-section, .summary-section, .conclusion-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background-color: #fafafa;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .transcription-section {
            border-left: 4px solid #28a745;
        }

        .summary-section {
            border-left: 4px solid #ffc107;
        }

        .conclusion-section {
            border-left: 4px solid #dc3545;
        }

        .edit-prompt {
            background-color: #fff3cd;
            color: #856404;
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ffeaa7;
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
            font-size: 13px;
        }

        .generate-section {
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #28a745;
        }

        .generate-summary-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .generate-summary-btn:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .generate-summary-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        .generate-summary-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .generate-summary-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .generate-summary-btn:hover::before {
            left: 100%;
        }

        .transcription-section textarea,
        .summary-section textarea,
        .conclusion-section textarea {
            border: 2px solid #dee2e6;
            background-color: white;
            font-family: 'Arial', sans-serif;
            font-size: 14px;
            line-height: 1.5;
            min-height: 180px;
            width: 100%;
            padding: 15px;
            border-radius: 8px;
            resize: vertical;
        }

        /* Specific heights for each section */
        .transcription-section textarea {
            min-height: 200px;
        }

        .summary-section textarea {
            min-height: 180px;
        }

        .conclusion-section textarea {
            min-height: 180px;
        }

        /* Focus states for better UX */
        .transcription-section textarea:focus,
        .summary-section textarea:focus,
        .conclusion-section textarea:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
            transform: scale(1.01);
            transition: all 0.3s ease;
        }

        .transcription-section label,
        .summary-section label,
        .conclusion-section label {
            color: #333;
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
        }

        /* Update modal size for better content display */
        .patient-notes-modal {
            max-width: 1000px;
            max-height: 90vh;
            width: 95%;
        }

        /* Autocomplete styles */
        .autocomplete-container {
            position: relative;
            width: 100%;
            background-color: transparent;
            pointer-events: auto;
        }

        .name-input-modal .autocomplete-container {
            background-color: transparent !important;
            pointer-events: auto !important;
            z-index: 10001;
        }

        .autocomplete-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            font-family: Arial, sans-serif;
            box-sizing: border-box;
            outline: none;
            background-color: #ffffff !important;
            color: #333333 !important;
            cursor: text !important;
            opacity: 1 !important;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            appearance: none;
        }

        .autocomplete-input:focus {
            border-color: #007bff !important;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.4) !important;
            background-color: #ffffff !important;
            color: #333333 !important;
            cursor: text !important;
        }

        .autocomplete-input:hover {
            border-color: #999 !important;
            cursor: text !important;
        }

        .autocomplete-input::placeholder {
            color: #888 !important;
            opacity: 1 !important;
        }

        /* Ensure inputs in modal are accessible */
        .name-input-modal .autocomplete-input {
            position: relative;
            z-index: 10001;
            pointer-events: auto !important;
            background-color: #ffffff !important;
            color: #333333 !important;
            cursor: text !important;
            opacity: 1 !important;
        }

        .name-input-modal .autocomplete-input:focus {
            background-color: #ffffff !important;
            color: #333333 !important;
            cursor: text !important;
            border-color: #007bff !important;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10002;             /* Above modal inputs */
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .autocomplete-suggestion {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .autocomplete-suggestion:hover,
        .autocomplete-suggestion.selected {
            background-color: #f0f0f0;
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        /* Modal overlay for name input */
        .name-input-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;                /* Increased z-index */
        }

        .name-input-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            min-width: 400px;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            position: relative;
            z-index: 10000;
            user-select: auto;
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
        }

        .name-input-content * {
            user-select: auto;
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
        }

        .name-input-content input {
            user-select: text !important;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
        }

        .name-input-content h3 {
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }

        .name-field {
            margin-bottom: 20px;
            background-color: transparent;
            pointer-events: auto;
        }

        .name-field label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            pointer-events: none;
        }

        .name-input-modal .name-field {
            background-color: transparent !important;
            pointer-events: auto !important;
        }

        .name-input-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 30px;
        }

        .name-input-buttons button {
            flex: 1;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        /* Problem row and pill styles */
        .problem-row {
            display: flex;
            align-items: center;
            gap: 8px;                    /* Reduced gap */
            margin: 5px 0;               /* Reduced margin */
            padding: 8px;                /* Reduced padding */
            background-color: #f8f9fa;
            border-radius: 8px;
            flex-shrink: 0;              /* Don't shrink */
        }

        .pill {
            background-color: #007bff;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            cursor: default;
        }

        .pill.large {
            background-color: #e9ecef;
            color: #333;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            flex: 1;
            min-height: 40px;
            display: flex;
            align-items: center;
        }

        .pill.large:hover {
            background-color: #dee2e6;
        }

       .red-box {
        border: 2px solid red !important;
        border-radius: 6px;
        padding: 10px;
        margin: 8px auto;
        background-color: transparent;
        max-width: 180px;
        max-height: 250px;           /* Increased from 200px to accommodate all buttons */
        overflow-y: auto;
        }

        /* Special styling for the first red box to ensure full visibility */
        .red-box:first-of-type {
            max-height: 280px;          /* Even more height for the first box with 5 buttons */
        }

        /* Custom scrollbar for red boxes */
        .red-box::-webkit-scrollbar {
            width: 6px;
        }

        .red-box::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .red-box::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 3px;
        }

        .red-box::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.8);
        }

        .red-box li {
        margin: 3px 0;               /* Reduced from 5px */
        }

        .red-box button {
        width: 45%;                  /* Increased from 20% for better readability */
        margin: 0 auto;
        display: block;
        white-space: normal;
        word-break: break-word;
        text-align: center;
        padding: 4px;
        box-sizing: border-box;
        font-size: 10px;
        min-height: 22px;
        }

        /* NEW: Conversation recording styles */
        .conversation-summary {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #4a90e2;
        }

        .conversation-transcript {
            margin-top: 10px;               /* Reduced from 20px */
            max-height: 120px;              /* Reduced from 200px */
            overflow-y: auto;
            padding-right: 5px;             /* Reduced from 10px */
        }

        /* Custom scrollbar for conversation transcript */
        .conversation-transcript::-webkit-scrollbar {
            width: 4px;                     /* Reduced from 6px */
        }

        .conversation-transcript::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .conversation-transcript::-webkit-scrollbar-thumb {
            background: #4a90e2;
            border-radius: 3px;
        }

        .conversation-transcript::-webkit-scrollbar-thumb:hover {
            background: #5ba0f2;
        }

        .transcript-segment {
            margin: 5px 0;                  /* Reduced from 10px */
            padding: 6px;                   /* Reduced from 10px */
            border-radius: 3px;             /* Reduced from 5px */
            border-left: 2px solid;         /* Reduced from 3px */
        }

        .doctor-segment {
            background: rgba(74, 144, 226, 0.1);
            border-left-color: #4a90e2;
        }

        .patient-segment {
            background: rgba(220, 53, 69, 0.1);
            border-left-color: #dc3545;
        }

        .role-label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        .doctor-segment .role-label {
            color: #4a90e2;
        }

        .patient-segment .role-label {
            color: #dc3545;
        }

        .segment-text {
            display: block;
            line-height: 1.4;
        }

        #conversation-status {
            font-style: italic;
            color: #bbb;
            margin: 5px 0;               /* Reduced from 10px */
            font-size: 11px;             /* Added smaller font size */
        }

        /* Scrollable conversation results container */
        #conversation-results {
            max-height: 200px !important;   /* Reduced from 300px */
            overflow-y: auto !important;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
            padding: 8px;                    /* Reduced from 10px */
            margin: 5px 0;                   /* Reduced from 10px */
            scrollbar-width: thin;
            scrollbar-color: #4a90e2 rgba(255, 255, 255, 0.1);
            font-size: 12px;                 /* Added smaller font size */
        }

        /* Custom scrollbar for conversation results */
        #conversation-results::-webkit-scrollbar {
            width: 6px;
        }

        #conversation-results::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        #conversation-results::-webkit-scrollbar-thumb {
            background: #4a90e2;
            border-radius: 3px;
        }

        #conversation-results::-webkit-scrollbar-thumb:hover {
            background: #5ba0f2;
        }

        /* Patient problem display styling */
        .patient-problem-text {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #4a90e2;
            border-radius: 4px;
            padding: 8px;
            margin: 5px 0;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .patient-problem-text:hover {
            background: rgba(74, 144, 226, 0.2);
        }

        .patient-problem-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #4a90e2;
            border-radius: 4px;
            padding: 8px;
            color: #fff;
            font-size: 14px;
        }

        /* Input group styling for conversation box */
        .input-group {
            margin: 5px 0;               /* Reduced from 10px */
        }

        .input-group label {
            display: block;
            margin-bottom: 3px;          /* Reduced from 5px */
            color: #ddd;
            font-size: 11px;             /* Reduced from 12px */
            font-weight: bold;
        }

        .autocomplete-container {
            position: relative;
            width: 100%;
        }

        .autocomplete-input {
            width: 100%;
            padding: 6px;                /* Reduced from 8px */
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #4a90e2;
            border-radius: 4px;
            color: #fff;
            font-size: 12px;             /* Reduced from 14px */
            box-sizing: border-box;
        }

        .autocomplete-input::placeholder {
            color: #aaa;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(30, 50, 80, 0.95);
            border: 1px solid #4a90e2;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-suggestion {
            padding: 8px;
            cursor: pointer;
            color: #ddd;
            border-bottom: 1px solid rgba(74, 144, 226, 0.3);
        }

        .autocomplete-suggestion:hover {
            background: rgba(74, 144, 226, 0.2);
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

    </style>
</head>
<body> 
    <div id="toast" class="toast"></div>

    <!-- Name Input Modal -->
    <div id="name-input-modal" class="name-input-modal" style="display: none;">
        <div class="name-input-content">
            <h3>Enter Names for Recording</h3>
            
            <div class="name-field">
                <label for="doctor-name-input">Doctor's Name:</label>
                <div class="autocomplete-container">
                    <input type="text" id="doctor-name-input" class="autocomplete-input" 
                           placeholder="Start typing doctor's name..." autocomplete="off">
                    <div id="doctor-suggestions" class="autocomplete-suggestions"></div>
                </div>
            </div>
            
            <div class="name-field">
                <label for="patient-name-input">Patient's Name:</label>
                <div class="autocomplete-container">
                    <input type="text" id="patient-name-input" class="autocomplete-input" 
                           placeholder="Start typing patient's name..." autocomplete="off">
                    <div id="patient-suggestions" class="autocomplete-suggestions"></div>
                </div>
            </div>
            
            <div class="name-input-buttons">
                <button type="button" class="btn-secondary" onclick="cancelNameInput()">Cancel</button>
                <button type="button" class="btn-primary" onclick="confirmNameInput()">Start Recording</button>
            </div>
        </div>
    </div>

    <!-- Patient Notes Modal -->
    <div id="patient-notes-modal" class="modal-overlay">
        <div class="patient-notes-modal">
            <!-- Enhanced Header -->
            <div class="main-header">
                <h1 id="patient-header">Patient ‚Äì [Patient Name] ‚Äì Recording Notes</h1>
                <h2>Patient Recording Notes</h2>
            </div>
            
            <!-- Patient and Doctor Names - Highlighted Section -->
            <div class="names-section">
                <div class="name-display">
                <strong>
                    Patient Name: <span id="display-patient-name">[Enter Patient Name]</span>
                    ‚Äì Patient ID: <span id="display-patient-id">[Enter Patient ID]</span>
                </strong>
                </div>
                <div class="name-display">
                    <strong>Doctor's Name: <span id="display-doctor-name">[Enter Doctor Name]</span></strong>
                </div>
            </div>

            <!-- Session Information Box -->
            <div class="session-info-box">
                <h3>Session Information</h3>
                <div class="session-details">
                    <div class="session-item">
                        <strong>Transcription Engine:</strong> Whisper; <strong>Summary Engine:</strong> OpenAI
                    </div>
                    <div class="session-item">
                        <strong>Date:</strong> <span id="modal-session-date"></span>
                    </div>
                </div>
            </div>

            <!-- Original Transcription Section -->
            <div class="transcription-section">
                <label for="modal-transcription">Original Transcription Text (Editable):</label>
                <div class="edit-prompt">Doctor, please edit accordingly</div>
                <textarea id="modal-transcription" placeholder="Transcribed audio will appear here..." title="You can edit this transcription text"></textarea>
                
                <!-- Generate Summary Button -->
                <div class="generate-section">
                    <button class="generate-summary-btn" onclick="generateSummaryFromTranscription()" id="generate-summary-btn">
                        Generate Medical Summary & Recommendations
                    </button>
                </div>
            </div>

            <!-- Medical Summary Section - Now Editable -->
            <div class="summary-section">
                <label for="modal-summary">Medical Summary (Editable):</label>
                <div class="edit-prompt">Doctor, please edit accordingly</div>
                <textarea id="modal-summary" placeholder="Click 'Generate Medical Summary & Recommendations' to create AI-generated summary, then edit as needed..." title="This field is editable after generation"></textarea>
            </div>

            <!-- Conclusion Section - Now Editable -->
            <div class="conclusion-section">
                <label for="modal-conclusion">Conclusion & Recommendations (Editable):</label>
                <div class="edit-prompt">Doctor, please edit accordingly</div>
                <textarea id="modal-conclusion" placeholder="Click 'Generate Medical Summary & Recommendations' to create AI-generated conclusions, then edit as needed..." title="This field is editable after generation"></textarea>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn save" onclick="savePatientNotesPDF()">Save as PDF</button>
                <button class="modal-btn cancel" onclick="cancelPatientNotes()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Conversation Segments Modal -->
    <div id="conversation-segments-modal" class="modal-overlay">
        <div class="conversation-segments-modal">
            <!-- Header -->
            <div class="main-header">
                <h1>Doctor-Patient Conversation Segments</h1>
                <h2>Voice Diarization Results</h2>
            </div>
            
            <!-- Conversation Info -->
            <div class="names-section">
                <div class="name-display">
                    <strong>Doctor: <span id="conv-doctor-name">Doctor</span></strong>
                </div>
                <div class="name-display">
                    <strong>Patient: <span id="conv-patient-name">Patient</span></strong>
                </div>
                <div class="name-display">
                    <strong>Processing Date: <span id="conv-date"></span></strong>
                </div>
            </div>

            <!-- Session Information Box -->
            <div class="session-info-box">
                <h3>Processing Information</h3>
                <div class="session-details">
                    <div class="session-item">
                        <strong>Voice Diarization:</strong> OpenAI-based Speaker Separation
                    </div>
                    <div class="session-item">
                        <strong>Transcription Engine:</strong> Whisper
                    </div>
                    <div class="session-item">
                        <strong>Total Segments:</strong> <span id="conv-total-segments">0</span>
                    </div>
                </div>
            </div>

            <!-- Segments Display -->
            <div class="segments-section">
                <label>Conversation Segments:</label>
                <div id="segments-container" class="segments-container">
                    <!-- Segments will be populated dynamically -->
                </div>
            </div>

            <!-- Full Transcript Section -->
            <div class="transcription-section">
                <label for="conv-full-transcript">Complete Transcript (Editable):</label>
                <div class="edit-prompt">Doctor, please edit accordingly</div>
                <textarea id="conv-full-transcript" placeholder="Complete conversation transcript will appear here..." title="You can edit this transcript"></textarea>
                
                <!-- Generate Summary Button -->
                <div class="generate-section">
                    <button class="generate-summary-btn" onclick="generateConversationSummaryFromTranscript()" id="conv-generate-summary-btn">
                        Generate Medical Summary & Recommendations
                    </button>
                </div>
            </div>

            <!-- Summary Section -->
            <div class="summary-section">
                <label for="conv-summary">Medical Summary (Editable):</label>
                <div class="edit-prompt">Doctor, please review and edit accordingly</div>
                <textarea id="conv-summary" placeholder="AI-generated medical summary will appear here..." title="You can edit this summary"></textarea>
            </div>

            <!-- Conclusion Section -->
            <div class="conclusion-section">
                <label for="conv-conclusion">Conclusion & Recommendations (Editable):</label>
                <div class="edit-prompt">Doctor, please review and edit accordingly</div>
                <textarea id="conv-conclusion" placeholder="AI-generated conclusion and recommendations will appear here..." title="You can edit this conclusion"></textarea>
            </div>

            <!-- Modal Buttons -->
            <div class="modal-buttons">
                <button class="modal-btn save" onclick="saveConversationPDF()">Save as PDF</button>
                <button class="modal-btn cancel" onclick="closeConversationModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <ul>
                <!-- inside your existing <ul> ... -->
                <li class="no-bullet">
                <ul class="red-box">
                    <li>
                    <button class="light-btn" onclick="document.getElementById('pdf-upload').click()">Choose Files</button>
                    <input type="file" id="pdf-upload" multiple style="display: none;">
                    </li>
                    <li>
                    <button class="dark-btn" onclick="uploadFiles('pdf')">Add PDF</button>
                    </li>
                    <li>
                    <button class="light-btn" onclick="document.getElementById('url-upload').click()">Choose URL</button>
                    <input type="file" id="url-upload" multiple style="display: none;">
                    </li>
                    <li>
                    <button class="dark-btn" onclick="uploadFiles('url')">Add URL</button>
                    </li>
                    <li>
                    <button class="dark-btn" onclick="createVectorDB()">Update KB</button>
                    </li>
                </ul>
                </li>

                
            <li class="no-bullet">
            <ul class="red-box">
                <li>
                    <button class="dark-btn" onclick="startPatientRecording()">Record Patient Notes</button>
                </li>
                <li>
                    <button class="light-btn" onclick="stopPatientRecording()" id="stop-patient-btn" disabled>Stop Patient Recording</button>
                </li>
            </ul>
            </li>

            <!-- Third Red Box: Doctor-Patient Conversation -->
            <li class="no-bullet">
            <ul class="red-box">
                <li>
                    <button class="dark-btn" onclick="startConversationRecording()" id="start-conversation-btn">Doc / Patient Conversation</button>
                </li>
                <li>
                    <button class="light-btn" onclick="stopConversationRecording()" id="stop-conversation-btn" disabled>Stop Recording</button>
                </li>
            </ul>
            </li>
        </div>

        <div class="chat-container">
            <div class="chat-header">
                <div class="header-content">
                    <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/PCES_LOGO.jpg-bzxqGCUzF83KKZavbHqIbwpxnCTvnD.jpeg" alt="PCES Logo" class="logo">
                    <h1>PATIENT CARE ENHANCED SERVICES - PCES</h1>
                </div>
            </div>
            <div id="chat-messages" class="chat-messages"></div>
            
            <!-- Problem Row Section -->
            <div class="problem-row">
              <div class="pill">Patient's Problem</div>
              <div class="pill large" id="problem-text" title="Double-click to edit">35 Years Male patient with Type 2 Diabetes and High BP</div>
            </div>
            
            <div class="chat-input">
                <input type="text" id="user-input" placeholder="Type your message...">
                <button id="send-btn" onclick="sendMessage()">Generate</button>
                <button id="plain-english-btn" onclick="refineInput()">Plain English</button>
                <button id="save-btn" disabled onclick="saveChat()">Save as PDF</button>
                <button id="voice-btn" onclick="startRecording()">Start Recording</button>
                <button id="stop-btn" disabled onclick="stopRecording()">Stop Recording</button>
            </div>
        </div>
    </div>

    <script>
        function showToast(message, duration = 3000) {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.classList.add("show");
            setTimeout(() => {
                toast.classList.remove("show");
            }, duration);
        }

        function hideToast() {
            const toast = document.getElementById("toast");
            toast.classList.remove("show");
        }

        // Autocomplete functionality
        let doctorSearchTimeout;
        let patientSearchTimeout;
        let selectedDoctorIndex = -1;
        let selectedPatientIndex = -1;
        let currentOperation = null; // Track whether we're doing 'patient_recording' or 'chat_save'

        function setupAutocomplete() {
            const doctorInput = document.getElementById('doctor-name-input');
            const patientInput = document.getElementById('patient-name-input');
            const doctorSuggestions = document.getElementById('doctor-suggestions');
            const patientSuggestions = document.getElementById('patient-suggestions');

            // Doctor name autocomplete
            doctorInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                clearTimeout(doctorSearchTimeout);
                selectedDoctorIndex = -1;

                if (query.length < 2) {
                    doctorSuggestions.style.display = 'none';
                    return;
                }

                doctorSearchTimeout = setTimeout(() => {
                    searchDoctors(query);
                }, 300);
            });

            doctorInput.addEventListener('keydown', function(e) {
                handleAutocompleteKeydown(e, doctorSuggestions, 'doctor');
            });

            doctorInput.addEventListener('blur', function() {
                setTimeout(() => {
                    doctorSuggestions.style.display = 'none';
                }, 200);
            });

            // Patient name autocomplete
            patientInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                clearTimeout(patientSearchTimeout);
                selectedPatientIndex = -1;
                
                // Clear selected patient ID when user types manually
                window.selectedPatientId = null;

                if (query.length < 2) {
                    patientSuggestions.style.display = 'none';
                    return;
                }

                patientSearchTimeout = setTimeout(() => {
                    searchPatients(query);
                }, 300);
            });

            patientInput.addEventListener('keydown', function(e) {
                handleAutocompleteKeydown(e, patientSuggestions, 'patient');
            });

            patientInput.addEventListener('blur', function() {
                setTimeout(() => {
                    patientSuggestions.style.display = 'none';
                }, 200);
            });
        }

        async function searchDoctors(query) {
            try {
                const response = await fetch(`/search_doctors?q=${encodeURIComponent(query)}`);
                const doctors = await response.json();
                displaySuggestions(doctors, 'doctor-suggestions', 'doctor');
            } catch (error) {
                console.error('Error searching doctors:', error);
            }
        }

        async function searchPatients(query) {
            try {
                const response = await fetch(`/search_patients?q=${encodeURIComponent(query)}`);
                const patients = await response.json();
                displaySuggestions(patients, 'patient-suggestions', 'patient');
            } catch (error) {
                console.error('Error searching patients:', error);
            }
        }

        function displaySuggestions(suggestions, containerId, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (suggestions.length === 0) {
                container.style.display = 'none';
                return;
            }

            suggestions.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-suggestion';
                div.textContent = item.full_name;
                
                // Store the full item data as a data attribute for patients
                if (type === 'patient') {
                    div.setAttribute('data-patient-id', item.patient_id);
                    div.setAttribute('data-full-name', item.full_name);
                }
                
                div.addEventListener('click', () => {
                    if (type === 'patient') {
                        selectSuggestion(item.full_name, type, item.patient_id);
                    } else {
                        selectSuggestion(item.full_name, type);
                    }
                });
                container.appendChild(div);
            });

            container.style.display = 'block';
        }

        function handleAutocompleteKeydown(e, suggestionContainer, type) {
            const suggestions = suggestionContainer.querySelectorAll('.autocomplete-suggestion');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (type === 'doctor') {
                    selectedDoctorIndex = Math.min(selectedDoctorIndex + 1, suggestions.length - 1);
                } else {
                    selectedPatientIndex = Math.min(selectedPatientIndex + 1, suggestions.length - 1);
                }
                updateSelection(suggestions, type);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (type === 'doctor') {
                    selectedDoctorIndex = Math.max(selectedDoctorIndex - 1, 0);
                } else {
                    selectedPatientIndex = Math.max(selectedPatientIndex - 1, 0);
                }
                updateSelection(suggestions, type);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const selectedIndex = type === 'doctor' ? selectedDoctorIndex : selectedPatientIndex;
                if (selectedIndex >= 0 && suggestions[selectedIndex]) {
                    const selectedElement = suggestions[selectedIndex];
                    if (type === 'patient') {
                        const patientId = selectedElement.getAttribute('data-patient-id');
                        const fullName = selectedElement.getAttribute('data-full-name');
                        selectSuggestion(fullName, type, patientId);
                    } else {
                        selectSuggestion(selectedElement.textContent, type);
                    }
                }
            } else if (e.key === 'Escape') {
                suggestionContainer.style.display = 'none';
                if (type === 'doctor') {
                    selectedDoctorIndex = -1;
                } else {
                    selectedPatientIndex = -1;
                }
            }
        }

        function updateSelection(suggestions, type) {
            suggestions.forEach((suggestion, index) => {
                suggestion.classList.remove('selected');
            });

            const selectedIndex = type === 'doctor' ? selectedDoctorIndex : selectedPatientIndex;
            if (selectedIndex >= 0 && suggestions[selectedIndex]) {
                suggestions[selectedIndex].classList.add('selected');
            }
        }

        function selectSuggestion(fullName, type, patientId = null) {
            const inputId = type === 'doctor' ? 'doctor-name-input' : 'patient-name-input';
            const suggestionId = type === 'doctor' ? 'doctor-suggestions' : 'patient-suggestions';
            
            document.getElementById(inputId).value = fullName;
            document.getElementById(suggestionId).style.display = 'none';
            
            // Store patient_id when a patient is selected
            if (type === 'patient' && patientId) {
                window.selectedPatientId = patientId;
                console.log('Selected patient ID:', patientId);
            }
            
            if (type === 'doctor') {
                selectedDoctorIndex = -1;
            } else {
                selectedPatientIndex = -1;
            }
        }

        function showNameInputModal(operation = 'patient_recording') {
            currentOperation = operation;
            
            document.getElementById('name-input-modal').style.display = 'flex';
            document.getElementById('doctor-name-input').value = '';
            document.getElementById('patient-name-input').value = '';
            document.getElementById('doctor-suggestions').style.display = 'none';
            document.getElementById('patient-suggestions').style.display = 'none';
            
            // Reset selected patient ID
            window.selectedPatientId = null;
            
            // Update modal title and button text based on operation
            const modalTitle = document.querySelector('#name-input-modal h3');
            const confirmButton = document.querySelector('#name-input-modal .btn-primary');
            
            if (operation === 'chat_save') {
                modalTitle.textContent = 'Enter Names for PDF Save';
                confirmButton.textContent = 'Save PDF';
                // Make patient name optional for chat save
                document.getElementById('patient-name-input').placeholder = 'Patient name (optional)';
            } else if (operation === 'conversation_recording') {
                modalTitle.textContent = 'Enter Names for Conversation Recording';
                confirmButton.textContent = 'Start Recording';
                // Make patient name required for conversation recording
                document.getElementById('patient-name-input').placeholder = 'Start typing patient\'s name...';
            } else {
                modalTitle.textContent = 'Enter Names for Recording';
                confirmButton.textContent = 'Start Recording';
                // Make patient name required for recording
                document.getElementById('patient-name-input').placeholder = 'Start typing patient\'s name...';
            }
            
            setupAutocomplete();
            
            // Focus on doctor input
            setTimeout(() => {
                document.getElementById('doctor-name-input').focus();
            }, 100);
        }

        function cancelNameInput() {
            document.getElementById('name-input-modal').style.display = 'none';
            currentOperation = null; // Reset operation type
        }

        function confirmNameInput() {
            const doctorName = document.getElementById('doctor-name-input').value.trim();
            const patientName = document.getElementById('patient-name-input').value.trim();

            if (!doctorName) {
                alert("Doctor name is required!");
                return;
            }

            if (currentOperation === 'patient_recording') {
                // For patient recording, both names and patient ID are required
                if (!patientName) {
                    alert("Patient name is required for recording!");
                    return;
                }

                // Check if patient was selected from autocomplete (has patient_id)
                if (!window.selectedPatientId) {
                    alert("Please select a patient from the dropdown suggestions!");
                    return;
                }

                document.getElementById('name-input-modal').style.display = 'none';
                startPatientRecordingWithNames(doctorName, patientName, window.selectedPatientId);
            } else if (currentOperation === 'conversation_recording') {
                // For conversation recording, both names are required
                if (!patientName) {
                    alert("Patient name is required for conversation recording!");
                    return;
                }

                document.getElementById('name-input-modal').style.display = 'none';
                startConversationRecordingWithNames(doctorName, patientName);
            } else if (currentOperation === 'chat_save') {
                // For chat save, patient name is optional
                document.getElementById('name-input-modal').style.display = 'none';
                saveChatWithNames(doctorName, patientName);
            }
        }
        
        // Global variables for recording functionality
        let audioChunks = [];
        let mediaRecorder;
        let mediaStream;
        let patientRecordingTimeout;
        let currentPatientData = null; // Store current patient recording data
        
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const saveBtn = document.getElementById('save-btn');
        let messages = [];
        let messageCount = 0;
        const MAX_MESSAGES = 20;

        function addMessage(role, content) {
            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${role === 'user' ? 'user-message' : 'ai-message'}`;

            const messageContentDiv = document.createElement("div");
            messageContentDiv.className = "message-content";
            
            // For AI responses, check if there are citations and handle them separately
            if (role === 'ai') {
                // Split content into main response and citations
                const citationsIndex = content.indexOf('**Citations:**');
                let mainContent = content;
                let citationsContent = '';
                
                if (citationsIndex !== -1) {
                    mainContent = content.substring(0, citationsIndex).trim();
                    citationsContent = content.substring(citationsIndex).trim();
                }
                
                // Check if content is HTML or markdown
                if (mainContent.includes('<div') || mainContent.includes('<h4') || mainContent.includes('<a href')) {
                    // This is HTML content from enhanced tools - render directly
                    messageContentDiv.innerHTML = mainContent;
                } else {
                    // This is markdown content - process through renderMarkdown
                    messageContentDiv.innerHTML = renderMarkdown(mainContent);
                }
                
                // If there are citations, create a separate citations div
                if (citationsContent) {
                    const citationsDiv = document.createElement("div");
                    citationsDiv.className = "citations-section";
                    if (citationsContent.includes('<a href') || citationsContent.includes('<div')) {
                        // HTML citations - render directly
                        citationsDiv.innerHTML = citationsContent;
                    } else {
                        // Markdown citations - process through renderMarkdown
                        citationsDiv.innerHTML = renderMarkdown(citationsContent);
                    }
                    messageDiv.appendChild(messageContentDiv);
                    messageDiv.appendChild(citationsDiv);
                } else {
                    messageDiv.appendChild(messageContentDiv);
                }
            } else {
                // For user messages, just use text content
                messageContentDiv.textContent = content.trim();
                messageDiv.appendChild(messageContentDiv);
            }

            if (role === "user") {
                const editButton = document.createElement("button");
                editButton.className = "edit-btn";
                editButton.textContent = "‚úé";
                editButton.onclick = () => editMessage(messageDiv, content);
                messageContentDiv.appendChild(editButton);
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            messages.push({ role, content });
            messageCount++;
            updateButtonsState();
        }

        function editMessage(messageDiv, originalContent) {
            // Prevent multiple edit inputs
            if (messageDiv.querySelector(".edit-input")) return;

            const messageTextDiv = messageDiv.querySelector(".message-content");

            // Create an input field for editing
            const inputField = document.createElement("textarea");
            inputField.className = "edit-input";
            inputField.value = originalContent;
            messageTextDiv.after(inputField);
            inputField.focus();

            // Remove existing buttons to prevent duplicates
            cleanupEditButtons(messageDiv);

            // Create Save button
            const saveButton = document.createElement("button");
            saveButton.textContent = "Save";
            saveButton.className = "save-btn";
            saveButton.onclick = () => {
                const editedContent = inputField.value.trim();

                if (editedContent && editedContent !== originalContent) {
                    // Send only the edited content for processing
                    sendTranscription(editedContent);

                    // Remove input field after sending
                    inputField.remove();
                } else {
                    inputField.replaceWith(messageTextDiv); // Restore old message
                }

                cleanupEditButtons(messageDiv);
            };

            // Create Cancel button
            const cancelButton = document.createElement("button");
            cancelButton.textContent = "Cancel";
            cancelButton.className = "cancel-btn";
            cancelButton.onclick = () => {
                inputField.remove();
                cleanupEditButtons(messageDiv);
            };

            // Append buttons
            messageDiv.appendChild(saveButton);
            messageDiv.appendChild(cancelButton);
        }

        // Function to add Edit button
        function addEditButton(messageDiv, content) {
            let existingEditButton = messageDiv.querySelector(".edit-btn");
            if (existingEditButton) existingEditButton.remove(); // Remove if exists

            const editButton = document.createElement("button");
            editButton.className = "edit-btn";
            editButton.textContent = "‚úé";
            editButton.onclick = () => editMessage(messageDiv, content);
            messageDiv.appendChild(editButton);
        }

        // Remove Save & Cancel buttons after action
        function cleanupEditButtons(messageDiv) {
            messageDiv.querySelectorAll(".save-btn, .cancel-btn").forEach(btn => btn.remove());
        }



        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            addMessage('user', message);
            userInput.value = '';
            sendBtn.disabled = true;
            saveBtn.disabled = true;
            
            // Update routing status
            updateRoutingStatus('Analyzing query and routing to relevant medical disciplines...');

            try {
                const response = await fetch('/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: message })
                });

                const data = await response.json();
                if (data.response) {
                    const aiMessage = data.message;
                    addMessage('ai', aiMessage);
                    
                    // Update routing status with details
                    if (data.routing_details) {
                        updateRoutingStatus(
                            `Query processed successfully`, 
                            {
                                disciplines: data.routing_details.disciplines,
                                sources: data.routing_details.sources,
                                confidence: `${data.routing_details.method} routing`
                            }
                        );
                    } else {
                        updateRoutingStatus('Query processed successfully');
                    }
                    
                    sendBtn.disabled = false;
                    saveBtn.disabled = false;
                } else {
                    console.error('Error:', data.message);
                    updateRoutingStatus('Error processing query');
                }
            } catch (error) {
                console.error('Error:', error);
                updateRoutingStatus('Network error');
            } finally {
                sendBtn.disabled = false;
            }
            updateButtonsState(); // after 10 max messages, force the user to save
        }

        function updateButtonsState() { 
            console.log("msg count:")
            console.log(messageCount)
            if (messageCount >= MAX_MESSAGES) {
                sendBtn.disabled = true;
                saveBtn.disabled = false;
                alert("System reached max 20 conversations, prompting you to save this session now. You may continue.");
                saveChat();
            } else {
                sendBtn.disabled = false;
                saveBtn.disabled = false;
            }
        }


        function saveChat() {
            // Show the name input modal for chat saving
            showNameInputModal('chat_save');
        }

        function saveChatWithNames(doctorName, patientName) {
            const now = new Date();
            const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
            
            showToast("üîÑ Generating PDF... Please wait.");

            // Prepare data for PDF generation
            // Get patient problem from the editable element (same as patient PDF)
            const patientProblemElement = document.getElementById('problem-text');
            const patientProblem = patientProblemElement ? patientProblemElement.textContent.trim() : '';
            
            const pdfData = {
                doctorName: doctorName,
                patientName: patientName || '', // Include patient name if provided
                patientId: '', // Add patientId field for consistency
                patientProblem: patientProblem, // Include patient problem
                messages: messages,
                jsonData: '' // You can add JSON data here if needed
            };

            // Generate and download PDF
            fetch('/generate_chat_pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(pdfData)
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('Failed to generate PDF');
                }
            })
            .then(blob => {
                // Create download link
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                
                // Include patient name in filename if provided
                let filename = `${doctorName.toUpperCase().replace(/\s+/g, '')}-${timestamp}.pdf`;
                if (patientName) {
                    filename = `${doctorName.toUpperCase().replace(/\s+/g, '')}-${patientName.toUpperCase().replace(/\s+/g, '')}-${timestamp}.pdf`;
                }
                
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                // Reset message count and buttons
                messageCount = 0;
                sendBtn.disabled = false;
                saveBtn.disabled = true;

                hideToast();
                showToast(`‚úÖ Chat saved as ${filename}`);
                setTimeout(() => hideToast(), 3000);

                // Reload page after saving 
                setTimeout(() => {
                    window.location.href = "/";
                }, 1000);
            })
            .catch(error => {
                console.error('Error generating PDF:', error);
                hideToast();
                showToast("‚ùå Error generating PDF. Please try again.", 5000);
            });
        }


        userInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        async function refineInput() {
            const inputField = document.getElementById('user-input');
            const userText = inputField.value.trim();

            if (!userText) return;

            try {
                const response = await fetch('/plain_english', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: userText })
                });

                const data = await response.json();
                if (data.refined_text) {
                    inputField.value = data.refined_text; // Update input box with refined text
                } else {
                    console.error('Error:', data.message);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }


        async function sendTranscription(transcription) {
            if (!transcription.trim()) return;

            addMessage('user', transcription);
            userInput.value = '';
            sendBtn.disabled = true;
            saveBtn.disabled = true;

            try {
                const response = await fetch('/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: transcription })
                });

                const data = await response.json();
                if (data.response) {
                    const aiMessage = data.message;
                    addMessage('ai', aiMessage);
                    sendBtn.disabled = false;
                    saveBtn.disabled = false;
                } else {
                    console.error('Error:', data.message);
                }
            } catch (error) {
                console.error('Error:', error);
            } finally {
                sendBtn.disabled = false;
            }
            updateButtonsState();
        }


        async function sendTranscription(transcription) {
            if (!transcription.trim()) return;

            addMessage('user', transcription);
            userInput.value = '';
            sendBtn.disabled = true;
            saveBtn.disabled = true;

            try {
                const response = await fetch('/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: transcription })
                });

                const data = await response.json();
                if (data.response) {
                    const aiMessage = data.message;
                    addMessage('ai', aiMessage);
                    sendBtn.disabled = false;
                    saveBtn.disabled = false;
                } else {
                    console.error('Error:', data.message);
                }
            } catch (error) {
                console.error('Error:', error);
            } finally {
                sendBtn.disabled = false;
            }
            updateButtonsState();
        }

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaStream = stream;
                    mediaRecorder.addEventListener('dataavailable', event => {
                        audioChunks.push(event.data);
                    });
                    mediaRecorder.addEventListener('stop', () => {
                    const audioBlob = new Blob(audioChunks);
                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'recording.wav');

                    fetch('/transcribe', {
                        method: 'POST',
                        body: formData
                    })
                        .then(r => r.json())
                        .then(data => {
                        console.log('Transcription:', data.text);
                        document.getElementById('user-input').value = data.text;
                        })
                        .catch(err => console.error('Error:', err))
                        .finally(() => {
                        // now that the fetch is done (success or failure), hide the toast:
                        hideToast();
                        });

                    audioChunks = [];
                    mediaStream.getTracks().forEach(track => track.stop());
                    });

                    mediaRecorder.start();
                    document.getElementById('voice-btn').disabled = true;
                    document.getElementById('stop-btn').disabled = false;
                })
                .catch(error => console.error('Error:', error));
        }


        function stopRecording() {
            showToast("üéôÔ∏è Generating text... please wait.");
            mediaRecorder.stop();
            document.getElementById('voice-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
        }

        async function startPatientRecording() {
            // Show the name input modal instead of using prompts
            showNameInputModal();
        }

        async function startPatientRecordingWithNames(doctorName, patientName, patientId) {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaStream = stream;
                    audioChunks = []; // Reset audio chunks

                    // Store names and patient ID for later use
                    window.currentDoctorName = doctorName;
                    window.currentPatientName = patientName;
                    window.currentPatientId = patientId;

                    // Update button states
                    document.querySelector('button[onclick="startPatientRecording()"]').disabled = true;
                    document.getElementById('stop-patient-btn').disabled = false;

                    // Show recording status
                    showToast("üéôÔ∏è Recording patient notes... (Max 3 minutes)");

                    mediaRecorder.addEventListener('dataavailable', event => {
                        audioChunks.push(event.data);
                    });
                    
                    mediaRecorder.addEventListener('stop', async () => {
                        // Reset button states
                        document.querySelector('button[onclick="startPatientRecording()"]').disabled = false;
                        document.getElementById('stop-patient-btn').disabled = true;
                        
                        // Clear timeout if it exists
                        if (patientRecordingTimeout) {
                            clearTimeout(patientRecordingTimeout);
                            patientRecordingTimeout = null;
                        }
                        
                        showToast("üîÑ Processing audio... Please wait.");
                        
                        try {
                            const audioBlob = new Blob(audioChunks);
                            const now = new Date();
                            const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;

                            // Send audio to backend for transcription and summary
                            const formData = new FormData();
                            formData.append('audio', audioBlob, 'patient_recording.wav');
                            formData.append('doctor_name', doctorName);
                            formData.append('patient_name', patientName);

                            const response = await fetch('/transcribe_patient_notes', {
                                method: 'POST',
                                body: formData
                            });

                            const data = await response.json();
                            
                            if (data.success) {
                                // Store patient data for modal
                                currentPatientData = {
                                    doctorName: window.currentDoctorName || doctorName,
                                    patientName: window.currentPatientName || patientName,
                                    patientId: window.currentPatientId || 'Unknown ID',
                                    dateTime: now.toISOString(),
                                    wholeText: data.transcribed_text,
                                    summary: data.summary,
                                    conclusion: data.conclusion,
                                    timestamp: timestamp
                                };

                                // Show modal instead of direct download
                                showPatientNotesModal();
                                hideToast();
                                
                            } else {
                                throw new Error(data.error || 'Failed to process audio');
                            }
                            
                        } catch (error) {
                            console.error('Error processing patient recording:', error);
                            showToast("Error processing recording. Please try again.", 5000);
                        }
                        
                        mediaStream.getTracks().forEach(track => track.stop());
                    });

                    mediaRecorder.start();
                    
                    // Set 3-minute timeout
                    patientRecordingTimeout = setTimeout(() => {
                        if (mediaRecorder.state === 'recording') {
                            mediaRecorder.stop();
                            showToast("Recording automatically stopped after 3 minutes.");
                        }
                    }, 3 * 60 * 1000); // 3 minutes
                })
                .catch(error => {
                    console.error('Error accessing microphone:', error);
                    showToast("Error accessing microphone. Please check permissions.");
                    
                    // Reset button states on error
                    document.querySelector('button[onclick="startPatientRecording()"]').disabled = false;
                    document.getElementById('stop-patient-btn').disabled = true;
                });
        }

        function stopPatientRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                showToast("Recording stopped manually.");
                setTimeout(() => hideToast(), 2000);
            }
        }

        // Modal Functions for Patient Notes
        function showPatientNotesModal() {
            if (!currentPatientData) return;

            // Update main header with patient name
            const patientName = currentPatientData.patientName || '[Enter Patient Name]';
            document.getElementById('patient-header').textContent = `Patient ‚Äì ${patientName} ‚Äì Recording Notes`;

            // Update name displays
            document.getElementById('display-patient-name').textContent = patientName;
            document.getElementById('display-patient-id').textContent = currentPatientData.patientId || '[Enter Patient ID]';
            document.getElementById('display-doctor-name').textContent = currentPatientData.doctorName || '[Enter Doctor Name]';

            // Update session date
            const sessionDate = new Date(currentPatientData.dateTime).toLocaleString();
            document.getElementById('modal-session-date').textContent = sessionDate;

            // Populate modal fields
            document.getElementById('modal-transcription').value = currentPatientData.wholeText;
            
            // Clear summary and conclusion initially - they should be generated on button click
            document.getElementById('modal-summary').value = '';
            document.getElementById('modal-conclusion').value = '';

            // Show modal
            document.getElementById('patient-notes-modal').classList.add('show');
        }

        function hidePatientNotesModal() {
            document.getElementById('patient-notes-modal').classList.remove('show');
            currentPatientData = null;
        }

        function cancelPatientNotes() {
            if (confirm('Are you sure you want to cancel? All recording data will be lost.')) {
                hidePatientNotesModal();
                showToast("Patient recording cancelled.");
                setTimeout(() => hideToast(), 2000);
            }
        }

        // Function to generate summary from transcription
        function generateSummaryFromTranscription() {
            const transcriptionText = document.getElementById('modal-transcription').value.trim();
            const doctorName = currentPatientData?.doctorName || 'Unknown Doctor';
            const patientName = currentPatientData?.patientName || 'Unknown Patient';
            
            if (!transcriptionText) {
                alert('Please ensure there is transcription text available to generate a summary.');
                return;
            }

            // Show loading state
            const generateBtn = document.getElementById('generate-summary-btn');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = 'Generating Summary...';
            generateBtn.disabled = true;

            showToast('Generating medical summary and recommendations...');

            // Call the backend to generate summary
            fetch('/generate_summary', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    transcription: transcriptionText,
                    doctor_name: doctorName,
                    patient_name: patientName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Populate the fields with generated content
                    document.getElementById('modal-summary').value = data.summary;
                    document.getElementById('modal-conclusion').value = data.conclusion;
                    
                    hideToast();
                    showToast('Medical summary and recommendations generated successfully!');
                    
                    // Update currentPatientData with the new summary and conclusion
                    if (currentPatientData) {
                        currentPatientData.summary = data.summary;
                        currentPatientData.conclusion = data.conclusion;
                    }
                } else {
                    hideToast();
                    showToast('‚ùå Failed to generate summary. Please try again.');
                    console.error('Summary generation failed:', data.error);
                }
            })
            .catch(error => {
                console.error('Error generating summary:', error);
                hideToast();
                showToast('‚ùå Error generating summary. Please check your connection and try again.');
            })
            .finally(() => {
                // Restore button state
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
                setTimeout(() => hideToast(), 3000);
            });
        }

        function savePatientNotesPDF() {
            if (!currentPatientData) return;

            // Get updated values from modal and currentPatientData
            const doctorName = currentPatientData.doctorName || 'Unknown Doctor';
            const patientName = currentPatientData.patientName || 'Unknown Patient';
            const patientId = currentPatientData.patientId || 'N/A';
            const editedTranscription = document.getElementById('modal-transcription').value.trim();
            const editedSummary = document.getElementById('modal-summary').value.trim();
            const editedConclusion = document.getElementById('modal-conclusion').value.trim();

            if (!editedTranscription) {
                alert('Please ensure there is transcription content to save.');
                return;
            }

            // Show loading toast
            showToast("Generating PDF... Please wait.");

            // Prepare data for PDF generation
            const now = new Date(currentPatientData.dateTime);
            const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
            const formattedDate = now.toLocaleString(); // This will format like "8/23/2025, 12:05:13 AM"
            
            // NEW: Get patient problem from the editable element
            const patientProblemElement = document.getElementById('problem-text');
            const patientProblem = patientProblemElement ? patientProblemElement.textContent.trim() : '';
            
            const pdfData = {
                doctorName: doctorName,
                patientName: patientName,
                patientId: patientId,
                dateTime: formattedDate,
                transcription: editedTranscription,
                summary: editedSummary || 'No summary provided',
                conclusion: editedConclusion || 'No conclusion provided',
                patientProblem: patientProblem, // NEW: Include patient problem
                timestamp: timestamp
            };

            // Generate and download PDF
            fetch('/generate_patient_pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(pdfData)
            })
            .then(response => {
                if (response.ok) {
                    // Check for Azure URL in headers
                    const azureUrl = response.headers.get('X-Azure-URL');
                    return response.blob().then(blob => ({ blob, azureUrl }));
                } else {
                    throw new Error('Failed to generate PDF');
                }
            })
            .then(({ blob, azureUrl }) => {
                // Create download link
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${patientName.toUpperCase().replace(/\s+/g, '')}-${timestamp}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                // Hide modal and show success message
                hidePatientNotesModal();
                hideToast();
                let successMessage = `‚úÖ Patient notes saved as ${patientName.toUpperCase().replace(/\s+/g, '')}-${timestamp}.pdf`;
                if (azureUrl) {
                    successMessage += ' and uploaded to Azure Cloud Storage';
                }
                showToast(successMessage);
                setTimeout(() => hideToast(), 5000);
            })
            .catch(error => {
                console.error('Error generating PDF:', error);
                hideToast();
                showToast("‚ùå Error generating PDF. Please try again.", 5000);
            });
        }

        // Helper function to download files
        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Helper function to generate PDF content
        function generatePDFContent(data) {
            return `
PATIENT CONSULTATION REPORT
================================

Header Information:
------------------
Doctor's Name: ${data.header.doctorName}
Patient Name: ${data.header.patientName}
Date & Time: ${new Date(data.header.dateTime).toLocaleString()}

Full Transcription:
------------------
${data.wholeText}

Medical Summary:
---------------
${data.summary}

Conclusion & Recommendations:
----------------------------
${data.conclusion}

Technical Details:
-----------------
Recording Duration: ${data.metadata.recordingDuration}
Transcription Engine: ${data.metadata.transcriptionEngine}
Summary Generation: ${data.metadata.summaryEngine}
Generated on: ${new Date().toLocaleString()}
            `.trim();
        }

        async function uploadFiles(type) {     
            const inputElement = type === 'pdf' ? document.getElementById('pdf-upload') : document.getElementById('url-upload');
            const files = inputElement.files;

            if (!files.length) {
                showToast('No file uploaded');
                setTimeout(() => hideToast(), 1000);
                return;
            }

            let formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                if (files[i].size === 0) {  // Ensure file is not empty
                    showToast(`${files[i].name} is empty. Please upload a valid file.`);
                    setTimeout(() => hideToast(), 1000);
                    return;
                }
                formData.append('file', files[i]);
            }
            console.log(formData)
            formData.append('user', 'guest');

            const endpoint = type === 'pdf' ? '/upload_pdf' : '/upload_url';
            
            fetch(endpoint, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showToast(data.message || "Upload successful");
                setTimeout(() => hideToast(), 1000);
                console.log("Response:", data);
            })
            .catch(error => {
                showToast("Upload failed");
                setTimeout(() => hideToast(), 1000);
                console.error("Error:", error);
            });
        }


        
        async function createVectorDB() {
            showToast("Knowledge Bank is updating... please wait.");
            let response = await fetch('/create_vector_db', { method: 'POST' });
            let data = await response.json();
            showToast(" Knowledge Bank updated.");
            setTimeout(() => hideToast(), 1000);

        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }
        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.classList.add("show");
        }
        function hideToast() {
            const toast = document.getElementById("toast");
            toast.classList.remove("show");
        }

        // Simplified routing functions (no UI updates)
        function updateRoutingStatus(status, details = null) {
            // Routing happens silently in the background
            console.log('Routing:', status, details);
        }

        // Markdown rendering function
        function renderMarkdown(text) {
            // Remove emojis first
            text = text.replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '');
            
            // Convert markdown to HTML
            text = text
                // Headers (process first)
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                
                // Bold text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                
                // Convert line breaks
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>');
                
            return text;
        }

        // Load page
        document.addEventListener('DOMContentLoaded', function() {
            // Page loaded - routing ready
            console.log('AI Router Ready');
            
            // Add click handler to close modal when clicking outside
            document.getElementById('patient-notes-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    cancelPatientNotes();
                }
            });

            // Add keyboard handler for Escape key to close modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.getElementById('patient-notes-modal').classList.contains('show')) {
                    cancelPatientNotes();
                }
            });

            // Problem text editing functionality
            const problemText = document.getElementById('problem-text');
            if (problemText) {
                problemText.addEventListener('dblclick', function() {
                    const currentText = this.textContent;
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentText;
                    input.style.width = '100%';
                    input.style.padding = '10px 20px';
                    input.style.border = '2px solid #007bff';
                    input.style.borderRadius = '20px';
                    input.style.fontSize = '16px';
                    input.style.outline = 'none';
                    
                    // Replace the pill with input
                    this.style.display = 'none';
                    this.parentNode.appendChild(input);
                    input.focus();
                    input.select();
                    
                    // Save on Enter or blur
                    function saveEdit() {
                        problemText.textContent = input.value || currentText;
                        problemText.style.display = 'flex';
                        input.remove();
                    }
                    
                    input.addEventListener('blur', saveEdit);
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            saveEdit();
                        } else if (e.key === 'Escape') {
                            problemText.style.display = 'flex';
                            input.remove();
                        }
                    });
                });
            }
        });

        // NEW: Doctor-Patient Conversation Recording Functions
        let conversationRecordedChunks = [];
        let conversationIsRecording = false;

        async function startConversationRecording() {
            // Show the name input modal just like patient recording
            showNameInputModal('conversation_recording');
        }

        async function startConversationRecordingWithNames(doctorName, patientName) {
            // Store names for later use
            window.currentConversationDoctorName = doctorName;
            window.currentConversationPatientName = patientName;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                conversationRecordedChunks = [];
                mediaRecorder = new MediaRecorder(stream, { 
                    mimeType: 'audio/webm;codecs=opus' 
                });
                
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        conversationRecordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstart = function() {
                    conversationIsRecording = true;
                    document.getElementById('start-conversation-btn').disabled = true;
                    document.getElementById('stop-conversation-btn').disabled = false;
                    showToast('Recording doctor-patient conversation...');
                };
                
                mediaRecorder.onstop = function() {
                    conversationIsRecording = false;
                    document.getElementById('start-conversation-btn').disabled = false;
                    document.getElementById('stop-conversation-btn').disabled = true;
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                    
                    processConversationRecording();
                };
                
                mediaRecorder.start();
                
            } catch (error) {
                console.error('Error starting conversation recording:', error);
                showToast('Error starting recording. Please check microphone permissions.');
            }
        }

        function stopConversationRecording() {
            if (mediaRecorder && conversationIsRecording) {
                mediaRecorder.stop();
            }
        }

        async function processConversationRecording() {
            try {
                const audioBlob = new Blob(conversationRecordedChunks, { type: 'audio/webm;codecs=opus' });
                const formData = new FormData();
                formData.append('audio', audioBlob, 'conversation.webm');
                
                // Use the names that were collected from the modal
                const doctorName = window.currentConversationDoctorName || 'Doctor';
                const patientName = window.currentConversationPatientName || 'Patient';
                formData.append('doctor_name', doctorName);
                formData.append('patient_name', patientName);
                
                showToast('Processing conversation with voice diarization...');
                
                const response = await fetch('/transcribe_doctor_patient_conversation', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    hideToast();
                    showConversationModal(result.conversation_data);
                } else {
                    hideToast();
                    showToast(`Error: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Error processing conversation:', error);
                hideToast();
                showToast('Error processing conversation');
            }
        }

        // Global variable to store current conversation data
        let currentConversationData = null;

        function showConversationModal(conversationData) {
            currentConversationData = conversationData;
            
            // Debug: Log the conversation data structure
            console.log('üîç Conversation data received:', conversationData);
            console.log('üîç Transcript data:', conversationData.transcript);
            
            // Populate modal with conversation data
            document.getElementById('conv-doctor-name').textContent = conversationData.doctor_name || 'Doctor';
            document.getElementById('conv-patient-name').textContent = conversationData.patient_name || 'Patient';
            document.getElementById('conv-date').textContent = new Date(conversationData.session_date).toLocaleString();
            document.getElementById('conv-total-segments').textContent = conversationData.transcript ? conversationData.transcript.length : 0;
            
            // Populate segments
            const segmentsContainer = document.getElementById('segments-container');
            segmentsContainer.innerHTML = '';
            
            if (conversationData.transcript && conversationData.transcript.length > 0) {
                conversationData.transcript.forEach((segment, index) => {
                    const segmentDiv = document.createElement('div');
                    segmentDiv.className = `segment-item ${segment.role.toLowerCase()}`;
                    
                    const roleClass = segment.role.toLowerCase();
                    const confidenceText = segment.confidence ? `(${Math.round(segment.confidence * 100)}% confidence)` : '';
                    
                    segmentDiv.innerHTML = `
                        <div class="segment-header">
                            <span class="segment-role ${roleClass}">${segment.role}</span>
                            <div>
                                <span class="segment-timing">${segment.start} - ${segment.end}</span>
                                <span class="segment-confidence">${confidenceText}</span>
                            </div>
                        </div>
                        <div class="segment-text">${segment.text}</div>
                    `;
                    
                    segmentsContainer.appendChild(segmentDiv);
                });
            } else {
                segmentsContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No segments available</p>';
            }
            
            // Populate full transcript
            const fullTranscript = conversationData.transcript 
                ? conversationData.transcript.map(seg => `${seg.role}: ${seg.text}`).join('\n\n')
                : conversationData.raw_transcript || 'No transcript available';
            
            document.getElementById('conv-full-transcript').value = fullTranscript;
            
            // Clear summary and conclusion fields - they should be generated by clicking the button
            document.getElementById('conv-summary').value = '';
            document.getElementById('conv-conclusion').value = '';
            
            // Show modal
            document.getElementById('conversation-segments-modal').classList.add('show');
        }

        function closeConversationModal() {
            document.getElementById('conversation-segments-modal').classList.remove('show');
            currentConversationData = null;
        }

        function saveConversationPDF() {
            if (!currentConversationData) return;
            
            showToast("Generating Conversation PDF... Please wait.");
            
            // Prepare data for PDF generation
            const now = new Date(currentConversationData.session_date);
            const timestamp = now.toISOString().slice(0, 19).replace(/[-:]/g, '').replace('T', '');
            
            const pdfData = {
                doctorName: currentConversationData.doctor_name || 'Doctor',
                patientName: currentConversationData.patient_name || 'Patient',
                dateTime: now.toLocaleString(),
                segments: currentConversationData.transcript || [],
                fullTranscript: document.getElementById('conv-full-transcript').value,
                summary: document.getElementById('conv-summary').value,
                conclusion: document.getElementById('conv-conclusion').value,
                processingInfo: {
                    engine: 'OpenAI Voice Diarization + Whisper',
                    totalSegments: currentConversationData.transcript ? currentConversationData.transcript.length : 0
                }
            };
            
            // Generate and download PDF using existing chat PDF endpoint (we'll modify it)
            fetch('/generate_conversation_pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(pdfData)
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('Failed to generate conversation PDF');
                }
            })
            .then(blob => {
                // Create download link
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `CONVERSATION-${pdfData.doctorName.toUpperCase().replace(/\s+/g, '')}-${timestamp}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                // Close the modal after successful save
                closeConversationModal();
                
                hideToast();
                showToast(`‚úÖ Conversation PDF saved successfully!`);
                setTimeout(() => hideToast(), 3000);
            })
            .catch(error => {
                console.error('Error generating conversation PDF:', error);
                hideToast();
                showToast("‚ùå Error generating PDF. Please try again.", 5000);
            });
        }

        // Function to generate medical summary and recommendations from chat conversation
        function generateMedicalSummaryRecommendations() {
            // Check if there are messages to work with
            if (!messages || messages.length === 0) {
                showToast('‚ùå No conversation history found. Please have a medical conversation first.');
                setTimeout(() => hideToast(), 3000);
                return;
            }

            // Filter only meaningful medical messages (exclude empty or system messages)
            const meaningfulMessages = messages.filter(msg => 
                msg && msg.content && msg.content.trim().length > 10
            );

            if (meaningfulMessages.length < 2) {
                showToast('‚ùå Insufficient conversation data. Please have a more detailed medical discussion first.');
                setTimeout(() => hideToast(), 3000);
                return;
            }

            // Show loading state
            const generateBtn = document.getElementById('generate-medical-summary-btn');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = 'Generating Summary...';
            generateBtn.disabled = true;

            showToast('ü§ñ Analyzing conversation and generating medical summary & recommendations...');

            // Prepare conversation text for analysis
            const conversationText = meaningfulMessages.map((msg, index) => {
                const role = msg.role === 'user' ? 'Patient/User' : 'AI Medical Assistant';
                return `${role}: ${msg.content}`;
            }).join('\n\n');

            // Call the backend to generate medical summary
            fetch('/generate_summary', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    transcription: conversationText,
                    doctor_name: 'Medical AI Assistant',
                    patient_name: 'Patient from Chat Conversation'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideToast();
                    
                    // Display the generated summary and recommendations in the chat
                    const summaryMessage = `
**üè• MEDICAL SUMMARY & RECOMMENDATIONS**

**üìã CLINICAL SUMMARY:**
${data.summary}

**üí° RECOMMENDATIONS & CONCLUSIONS:**
${data.conclusion}

---
*Generated from conversation analysis at ${new Date().toLocaleString()}*
                    `;
                    
                    addMessage('ai', summaryMessage);
                    
                    showToast('‚úÖ Medical summary and recommendations generated successfully!');
                    setTimeout(() => hideToast(), 3000);
                    
                } else {
                    hideToast();
                    showToast('‚ùå Failed to generate medical summary. Please try again.');
                    console.error('Medical summary generation failed:', data.error);
                    setTimeout(() => hideToast(), 3000);
                }
            })
            .catch(error => {
                console.error('Error generating medical summary:', error);
                hideToast();
                showToast('‚ùå Error generating medical summary. Please check your connection and try again.');
                setTimeout(() => hideToast(), 3000);
            })
            .finally(() => {
                // Restore button state
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            });
        }

        // Function to generate medical summary and recommendations for conversation transcript
        function generateConversationSummaryFromTranscript() {
            const transcriptionText = document.getElementById('conv-full-transcript').value.trim();
            const doctorName = currentConversationData?.doctor_name || 'Unknown Doctor';
            const patientName = currentConversationData?.patient_name || 'Unknown Patient';
            
            if (!transcriptionText) {
                alert('Please ensure there is conversation transcript text available to generate a summary.');
                return;
            }

            // Show loading state
            const generateBtn = document.getElementById('conv-generate-summary-btn');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = 'Generating Summary...';
            generateBtn.disabled = true;

            showToast('ü§ñ Generating medical summary and recommendations from conversation...');

            // Call the backend to generate summary
            fetch('/generate_summary', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    transcription: transcriptionText,
                    doctor_name: doctorName,
                    patient_name: patientName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Populate the conversation modal fields with generated content
                    document.getElementById('conv-summary').value = data.summary;
                    document.getElementById('conv-conclusion').value = data.conclusion;
                    
                    hideToast();
                    showToast('‚úÖ Medical summary and recommendations generated successfully!');
                    
                    // Update currentConversationData with the new summary and conclusion
                    if (currentConversationData) {
                        currentConversationData.summary = data.summary;
                        currentConversationData.conclusion = data.conclusion;
                    }
                } else {
                    hideToast();
                    showToast('‚ùå Failed to generate conversation summary. Please try again.');
                    console.error('Conversation summary generation failed:', data.error);
                }
            })
            .catch(error => {
                console.error('Error generating conversation summary:', error);
                hideToast();
                showToast('‚ùå Error generating conversation summary. Please check your connection and try again.');
            })
            .finally(() => {
                // Restore button state
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
                setTimeout(() => hideToast(), 3000);
            });
        }

        // Initialize conversation recording when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for conversation recording buttons
            document.getElementById('start-conversation-btn').addEventListener('click', startConversationRecording);
            document.getElementById('stop-conversation-btn').addEventListener('click', stopConversationRecording);
            
            // Initial state
            document.getElementById('stop-conversation-btn').disabled = true;
            
            // Add event listener for conversation modal close
            document.getElementById('conversation-segments-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeConversationModal();
                }
            });
            
            // ESC key to close conversation modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.getElementById('conversation-segments-modal').classList.contains('show')) {
                    closeConversationModal();
                }
            });
        });

    </script>
</body>
</html>